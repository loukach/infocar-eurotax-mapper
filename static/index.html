<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infocar-Eurotax Mapping Tool v4</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================================
           CSS CUSTOM PROPERTIES
           ============================================================ */
        :root {
            --slate-950: #020617;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --slate-700: #334155;
            --slate-600: #475569;
            --slate-500: #64748b;
            --slate-400: #94a3b8;
            --slate-300: #cbd5e1;
            --slate-200: #e2e8f0;
            --slate-100: #f1f5f9;
            --slate-50:  #f8fafc;
            --white:     #ffffff;

            --indigo-700: #4338ca;
            --indigo-600: #4f46e5;
            --indigo-500: #6366f1;
            --indigo-100: #e0e7ff;
            --indigo-50:  #eef2ff;

            --emerald-600: #059669;
            --emerald-500: #10b981;
            --emerald-100: #d1fae5;
            --emerald-50:  #ecfdf5;

            --amber-600: #d97706;
            --amber-500: #f59e0b;
            --amber-100: #fef3c7;
            --amber-50:  #fffbeb;

            --rose-600: #e11d48;
            --rose-500: #f43f5e;
            --rose-100: #ffe4e6;
            --rose-50:  #fff1f2;

            --purple-600: #9333ea;
            --purple-500: #a855f7;
            --purple-100: #f3e8ff;
            --purple-50:  #faf5ff;

            --font-ui: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;

            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
            --shadow-lg: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
        }

        /* ============================================================
           RESET + BASE
           ============================================================ */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-ui);
            background: var(--slate-100);
            color: var(--slate-800);
            font-size: 13px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .container {
            margin: 0 auto;
            padding: 0 12px 24px;
        }

        /* ============================================================
           HEADER - Dark slim bar
           ============================================================ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 48px;
            background: var(--slate-950);
            color: var(--white);
            margin-bottom: 12px;
        }
        .header-title {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.01em;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: var(--slate-400);
        }
        .header-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--slate-600);
            flex-shrink: 0;
        }
        .status-dot.ready { background: var(--emerald-500); }
        .status-dot.error { background: var(--rose-500); }
        .status-dot.loading {
            background: var(--amber-500);
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        .header-version {
            color: var(--slate-500);
            font-family: var(--font-mono);
            font-size: 11px;
        }
        .header-divider {
            width: 1px;
            height: 16px;
            background: var(--slate-700);
        }

        /* ============================================================
           PROGRESS BAR
           ============================================================ */
        .progress-bar-container {
            width: 100%;
            height: 3px;
            background: var(--slate-200);
            overflow: hidden;
            margin-bottom: 12px;
            display: none;
        }
        .progress-bar-container.visible { display: block; }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--indigo-600), var(--indigo-500), var(--indigo-600));
            background-size: 200% 100%;
            animation: progressPulse 1.5s ease-in-out infinite;
            width: 100%;
        }
        @keyframes progressPulse {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ============================================================
           SEARCH SECTION
           ============================================================ */
        .search-section {
            background: var(--white);
            padding: 14px 16px;
            border-radius: var(--radius-lg);
            margin-bottom: 10px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--slate-200);
        }
        .search-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-input {
            flex: 1;
            min-width: 240px;
            max-width: 340px;
            padding: 9px 12px;
            font-size: 14px;
            font-family: var(--font-mono);
            border: 1px solid var(--slate-300);
            border-radius: var(--radius-md);
            background: var(--white);
            color: var(--slate-800);
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--indigo-500);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.12);
        }
        .search-input::placeholder { color: var(--slate-400); }
        .search-btn {
            padding: 9px 20px;
            background: var(--indigo-600);
            color: var(--white);
            border: none;
            border-radius: var(--radius-md);
            font-family: var(--font-ui);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }
        .search-btn:hover { background: var(--indigo-700); }
        .search-btn:disabled { background: var(--slate-300); cursor: not-allowed; }
        .profile-select {
            padding: 9px 10px;
            font-family: var(--font-ui);
            font-size: 12px;
            border: 1px solid var(--slate-300);
            border-radius: var(--radius-md);
            background: var(--white);
            color: var(--slate-700);
            min-width: 120px;
            cursor: pointer;
            transition: border-color 0.15s;
        }
        .profile-select:focus {
            outline: none;
            border-color: var(--indigo-500);
        }
        .search-status {
            margin-left: auto;
            color: var(--slate-500);
            font-size: 12px;
        }
        .search-status.error { color: var(--rose-600); }
        .search-status.success { color: var(--indigo-600); }

        /* ============================================================
           VEHICLE IDENTITY - Inline with search row
           ============================================================ */
        .search-divider {
            width: 1px;
            height: 32px;
            background: var(--slate-200);
            flex-shrink: 0;
        }
        .vehicle-identity {
            display: flex;
            align-items: baseline;
            gap: 8px;
            min-width: 0;
            flex: 1;
            overflow: hidden;
        }
        .vehicle-make-name {
            font-size: 15px;
            font-weight: 700;
            color: var(--slate-800);
            white-space: nowrap;
            flex-shrink: 0;
        }
        .vehicle-version {
            font-size: 14px;
            font-weight: 500;
            color: var(--slate-600);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ============================================================
           GAP COLUMN - Transparent separator between source and candidates
           ============================================================ */
        .col-gap,
        .col-gap-header {
            width: 3px !important;
            min-width: 3px;
            max-width: 3px;
            padding: 0 !important;
            background: transparent !important;
            border-top: none !important;
            border-bottom: none !important;
            border-left: none !important;
            border-right: none !important;
        }

        /* Vehicle class badge */
        .vehicle-class-badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.04em;
        }
        .class-CAR { background: var(--indigo-100); color: var(--indigo-700); }
        .class-LCV { background: var(--rose-100); color: var(--rose-600); }

        /* ============================================================
           NO RESULTS / NO CANDIDATES
           ============================================================ */
        .no-results {
            text-align: center;
            padding: 48px 20px;
            display: none;
        }
        .no-results.visible { display: block; }
        .no-results-card {
            display: inline-block;
            background: var(--rose-50);
            border: 1px solid var(--rose-100);
            border-radius: var(--radius-lg);
            padding: 24px 40px;
        }
        .no-results-card h3 {
            margin: 0 0 6px;
            color: var(--rose-600);
            font-size: 15px;
            font-weight: 600;
        }
        .no-results-card p { color: var(--slate-600); font-size: 13px; }
        .no-results-card .hint { color: var(--slate-400); font-size: 11px; margin-top: 4px; }

        .no-candidates-card {
            display: none;
            background: var(--amber-50);
            border: 1px solid var(--amber-100);
            border-radius: var(--radius-lg);
            padding: 14px 20px;
            margin-bottom: 10px;
        }
        .no-candidates-card.visible { display: block; }
        .no-candidates-card h4 {
            color: var(--amber-600);
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 3px;
        }
        .no-candidates-card p { color: var(--slate-600); font-size: 12px; }

        /* ============================================================
           MAIN COMPARISON TABLE - THE HERO
           ============================================================ */
        .main-panel {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--slate-200);
            overflow-x: auto;
            display: none;
        }
        .main-panel.visible { display: block; }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .comparison-table.expanded {
            table-layout: auto;
            min-width: max-content;
            width: auto;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 7px 10px;
            text-align: left;
            border-bottom: 1px solid var(--slate-200);
            vertical-align: top;
            font-size: 13px;
        }
        /* Zebra striping */
        .comparison-table tbody tr:nth-child(even) {
            background: var(--slate-50);
        }
        .comparison-table tbody tr:nth-child(even) .col-field {
            background: var(--slate-100);
        }
        .comparison-table tbody tr:nth-child(even) .col-source {
            background: #e8eeff;
        }
        .comparison-table tbody tr:nth-child(even) .col-cand-existing {
            background: #f0e8ff;
        }
        .comparison-table tbody tr:nth-child(even) .col-existing-not-matched {
            background: #f5edff;
        }

        .comparison-table thead th {
            font-weight: 600;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid var(--slate-200);
        }

        /* Column separator */
        .comparison-table th + th,
        .comparison-table td + td {
            border-left: 1px solid var(--slate-200);
        }

        /* Sticky header shadow on scroll */
        .comparison-table thead::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        }

        /* Field column */
        .col-field {
            width: 130px;
            min-width: 130px;
            background: var(--slate-50);
            font-weight: 500;
            color: var(--slate-500);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            position: sticky;
            left: 0;
            z-index: 5;
            border-right: 1px solid var(--slate-200) !important;
        }
        /* Source column */
        .col-source {
            width: 260px;
            background: var(--indigo-50);
            white-space: normal;
            word-wrap: break-word;
            position: sticky;
            left: 130px;
            z-index: 5;
        }
        .expanded .col-source {
            width: auto;
            min-width: 220px;
            max-width: 280px;
        }
        /* Candidate columns */
        .col-cand {
            white-space: normal;
            word-wrap: break-word;
            overflow: hidden;
        }
        .expanded .col-cand {
            min-width: 140px;
            max-width: 200px;
        }

        /* Header row styling */
        .col-header-field {
            background: var(--slate-100) !important;
            color: var(--slate-600) !important;
        }
        .col-header-source {
            background: var(--indigo-700) !important;
            color: var(--white) !important;
        }
        .col-header-source .th-title,
        .col-header-source .th-code,
        .col-header-source .copiable-code {
            color: var(--white) !important;
        }
        .col-header-cand {
            background: var(--white) !important;
            border-bottom: 2px solid var(--slate-200) !important;
        }

        /* Highlighted candidate column (IS the existing mapping) - purple bg, no borders */
        .col-header-cand-existing {
            background: var(--purple-100) !important;
        }
        .col-cand-existing {
            background: var(--purple-50);
        }

        /* Far-right existing mapping column (NOT in visible candidates) */
        .col-header-existing-only {
            background: var(--purple-50) !important;
            border-top: 3px dashed var(--purple-500) !important;
            border-bottom: 2px dashed var(--purple-500) !important;
        }
        .col-existing-not-matched {
            background: var(--purple-50) !important;
            border-left: 3px dashed var(--purple-500) !important;
        }

        /* Badges */
        .existing-badge {
            display: inline-block;
            padding: 2px 7px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.04em;
            background: var(--purple-500);
            color: var(--white);
        }
        .existing-badge.not-in-top {
            border: 1px dashed var(--purple-600);
        }

        /* OEM match badges */
        .oem-match-badge {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
        }
        .oem-EXACT { background: var(--emerald-100); color: var(--emerald-600); }
        .oem-CLEANED { background: var(--amber-100); color: var(--amber-600); }
        .oem-NONE { background: var(--slate-100); color: var(--slate-500); }

        /* ============================================================
           TABLE CONTENT
           ============================================================ */
        .th-title { font-size: 12px; font-weight: 600; }
        .th-code { font-family: var(--font-mono); font-size: 11px; }
        .th-meta { font-size: 10px; color: var(--slate-500); margin-top: 3px; }

        /* Natcode and mapping buttons */
        .natcode-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        .natcode-value {
            font-family: var(--font-mono);
            font-size: 14px;
            font-weight: 700;
        }

        /* Copiable code */
        .copiable-code {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            padding: 3px 7px;
            border-radius: var(--radius-sm);
            transition: background 0.15s;
            font-family: var(--font-mono);
            font-size: 13px;
            font-weight: 700;
        }
        .copiable-code:hover { background: rgba(0,0,0,0.06); }
        .col-header-source .copiable-code:hover { background: rgba(255,255,255,0.15); }
        .copiable-code .copy-icon {
            opacity: 0;
            width: 12px;
            height: 12px;
            transition: opacity 0.15s;
        }
        .copiable-code:hover .copy-icon { opacity: 0.7; }
        .copy-icon {
            width: 14px;
            height: 14px;
            vertical-align: middle;
        }

        /* Score micro-bar */
        .score-bar-container {
            margin-top: 5px;
            font-size: 11px;
            font-family: var(--font-mono);
            color: var(--slate-600);
        }
        .score-bar-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .score-bar-track {
            width: 60px;
            height: 6px;
            background: var(--slate-200);
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }
        .score-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .score-bar-fill.tier-high { background: var(--emerald-500); }
        .score-bar-fill.tier-medium { background: var(--amber-500); }
        .score-bar-fill.tier-low { background: var(--rose-500); }
        .score-pct {
            font-weight: 600;
        }
        .score-pct.tier-high { color: var(--emerald-600); }
        .score-pct.tier-medium { color: var(--amber-600); }
        .score-pct.tier-low { color: var(--rose-600); }

        /* Map / Copy buttons */
        .map-btn {
            padding: 5px 12px;
            background: var(--indigo-600);
            color: var(--white);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: var(--font-ui);
            font-size: 11px;
            font-weight: 600;
            transition: background 0.15s;
        }
        .map-btn:hover { background: var(--indigo-700); }
        .map-btn:disabled { background: var(--slate-300); cursor: not-allowed; }
        .map-btn.mapped { background: var(--emerald-500); }
        .map-btn.mapped:hover { background: var(--emerald-600); }

        /* Cell content */
        .cell-value { font-size: 13px; }
        .cell-normalized {
            font-size: 10px;
            color: var(--indigo-600);
            margin-top: 1px;
        }
        .cell-match {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            font-size: 10px;
            margin-left: 5px;
            font-weight: 700;
            vertical-align: middle;
        }
        .match-yes { background: var(--emerald-100); color: var(--emerald-600); }
        .match-no { background: var(--rose-100); color: var(--rose-600); }
        .match-warn { background: var(--amber-100); color: var(--amber-600); }

        /* Left border indicators */
        .cell-match-border { border-left: 3px solid var(--emerald-500) !important; }
        .cell-warn-border { border-left: 3px solid var(--amber-500) !important; }
        .cell-mismatch-border { border-left: 3px solid var(--rose-500) !important; }

        /* See more button */
        .see-more-col {
            background: var(--slate-50) !important;
            width: 70px;
            text-align: center;
            vertical-align: middle !important;
        }
        .see-more-btn {
            padding: 6px 8px;
            background: var(--white);
            color: var(--indigo-600);
            border: 1px solid var(--indigo-600);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-family: var(--font-ui);
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            transition: background 0.15s, color 0.15s;
        }
        .see-more-btn:hover {
            background: var(--indigo-600);
            color: var(--white);
        }

        /* ============================================================
           TOAST - Pill style
           ============================================================ */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: var(--slate-900);
            color: var(--white);
            padding: 10px 20px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.25s ease, transform 0.25s ease;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast-accent {
            width: 4px;
            height: 16px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .toast.success .toast-accent { background: var(--indigo-500); }
        .toast.error .toast-accent { background: var(--rose-500); }
        .toast.info .toast-accent { background: var(--slate-400); }

        /* ============================================================
           LOADING
           ============================================================ */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--slate-500);
        }

        /* ============================================================
           MOBILE RESPONSIVE
           ============================================================ */
        @media (max-width: 768px) {
            .header { padding: 0 12px; }
            .col-field, .col-source {
                position: relative;
                left: auto;
            }
            .search-input { min-width: 180px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <span class="header-title">Infocar-Eurotax Mapper</span>
        <div class="header-right">
            <div class="header-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="dataStatus">Connecting...</span>
            </div>
            <span class="header-divider"></span>
            <span class="header-version">v4.2</span>
        </div>
    </div>

    <div class="container">
        <div id="progressBar" class="progress-bar-container">
            <div class="progress-bar"></div>
        </div>

        <div class="search-section">
            <div class="search-row">
                <input type="text" id="searchInput" class="search-input"
                       placeholder="Infocar provider code"
                       onkeypress="if(event.key==='Enter')search()">
                <button id="searchBtn" class="search-btn" onclick="search()">Search</button>
                <select id="profileSelect" class="profile-select" onchange="onProfileChange()">
                    <option value="default">default</option>
                </select>
                <div class="search-divider"></div>
                <div id="vehicleIdentity" class="vehicle-identity" style="display:none;">
                    <span id="vehicleMake" class="vehicle-make-name"></span>
                    <span id="vehicleVersion" class="vehicle-version"></span>
                </div>
                <span id="searchStatus" class="search-status"></span>
            </div>
        </div>

        <div id="noResults" class="no-results">
            <div class="no-results-card">
                <h3>Vehicle not found</h3>
                <p>The Infocar provider code was not found in X-Catalog.</p>
                <p class="hint">Check VPN connection and verify the code is correct.</p>
            </div>
        </div>

        <div id="noCandidates" class="no-candidates-card">
            <h4>No Eurotax candidates found</h4>
            <p>The Infocar vehicle was found, but no matching Eurotax records exist in the database.</p>
        </div>

        <div id="mainPanel" class="main-panel">
            <table class="comparison-table">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div id="toast" class="toast"><span class="toast-accent"></span><span id="toastMsg"></span></div>
    </div>

    <script>
        // ============================================================
        // STATE
        // ============================================================
        let currentData = null;
        let showAllCands = false;
        let isSearching = false;
        let availableProfiles = {};
        let currentMaxScore = 157;

        // OEM match type descriptions (v4 - per candidate)
        const OEM_MATCH_DESCRIPTIONS = {
            'EXACT': 'Exact OEM',
            'CLEANED': 'Cleaned OEM',
            'NONE': 'No OEM match',
        };

        // ============================================================
        // PROFILES
        // ============================================================
        async function fetchProfiles() {
            try {
                const response = await fetch('/api/profiles');
                const data = await response.json();
                availableProfiles = data.profiles || {};
                const defaultProfile = data.default || 'default';
                const select = document.getElementById('profileSelect');
                select.innerHTML = '';
                for (const name of Object.keys(availableProfiles)) {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name + ' (' + availableProfiles[name].max_score + 'pt)';
                    if (name === defaultProfile) opt.selected = true;
                    select.appendChild(opt);
                }
                currentMaxScore = availableProfiles[defaultProfile]?.max_score || 157;
            } catch (err) {
                console.warn('Could not fetch profiles:', err);
            }
        }

        function onProfileChange() {
            const profile = document.getElementById('profileSelect').value;
            currentMaxScore = availableProfiles[profile]?.max_score || 157;
            // Auto-re-search if there's a current result
            if (currentData && currentData.found) {
                search();
            }
        }

        // ============================================================
        // HELPERS
        // ============================================================
        function formatWindow(begin, end) {
            const b = begin ? Math.floor(begin) : '?';
            const e = end ? Math.floor(end) : '?';
            return `${b} - ${e}`;
        }

        function getScoreTier(score, maxScore) {
            maxScore = maxScore || currentMaxScore || 157;
            const pct = score / maxScore;
            if (pct >= 0.6) return 'high';
            if (pct >= 0.4) return 'medium';
            return 'low';
        }

        function getVehicleClassBadge(vehicleClass) {
            if (!vehicleClass) return '';
            return `<span class="vehicle-class-badge class-${vehicleClass}">${vehicleClass}</span>`;
        }

        function getOemMatchBadge(oemMatchType) {
            if (!oemMatchType || oemMatchType === 'NONE') {
                return `<span class="oem-match-badge oem-NONE">${OEM_MATCH_DESCRIPTIONS['NONE']}</span>`;
            }
            const desc = OEM_MATCH_DESCRIPTIONS[oemMatchType] || oemMatchType;
            return `<span class="oem-match-badge oem-${oemMatchType}">${desc}</span>`;
        }

        function getMatchFromBreakdown(breakdownKey, breakdown, weights) {
            if (!breakdownKey || !breakdown || !weights) return {};
            const points = breakdown[breakdownKey] || 0;
            const max = weights[breakdownKey] || 0;
            if (max <= 0) return {};
            if (points >= max) return { matchClass: 'match-yes', matchIcon: '\u2713' };
            if (points > 0) return { matchClass: 'match-warn', matchIcon: '~' };
            return { matchClass: 'match-no', matchIcon: '\u2717' };
        }

        function renderScoreBar(score, maxScore) {
            const pct = Math.round((score / maxScore) * 100);
            const tier = getScoreTier(score, maxScore);
            return `<div class="score-bar-container">
                <div class="score-bar-label">
                    <span>${score}/${maxScore}</span>
                    <span class="score-bar-track"><span class="score-bar-fill tier-${tier}" style="width:${pct}%"></span></span>
                    <span class="score-pct tier-${tier}">${pct}%</span>
                </div>
            </div>`;
        }

        const copyIconSvg = `<svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;

        // Field definitions
        const FIELDS = [
            { key: '_code', label: 'OEM Code', special: true },
            { key: '_make', label: 'Make', special: true },
            { key: 'name', label: 'Version Name', breakdownKey: 'name' },
            { key: '_trim_level', label: 'Trim Level', special: true, isTrim: true },
            { key: 'model', label: 'Model (normalized)', breakdownKey: 'model' },
            { key: 'cc', label: 'CC', breakdownKey: 'cc' },
            { key: 'hp', label: 'HP', breakdownKey: 'hp' },
            { key: 'price', label: 'Price', breakdownKey: 'price', format: v => v ? '\u20AC' + v.toLocaleString() : '-' },
            { key: 'fuel', label: 'Fuel Type', breakdownKey: 'fuel', normKey: 'fuel_norm' },
            { key: 'body', label: 'Body Type', breakdownKey: 'body', normKey: 'body_norm' },
            { key: 'doors', label: 'Doors', breakdownKey: 'doors' },
            { key: 'seats', label: 'Seats', breakdownKey: 'seats' },
            { key: 'gears', label: 'Gears', breakdownKey: 'gears' },
            { key: 'gear_type', label: 'Transmission', breakdownKey: 'transmission', normKey: 'gear_type_norm' },
            { key: 'traction', label: 'Traction', breakdownKey: 'traction', normKey: 'traction_norm' },
            { key: 'kw', label: 'KW', breakdownKey: 'kw' },
            { key: 'mass', label: 'Mass (kg)', breakdownKey: 'mass' },
            { key: '_sellable_window', label: 'Sellable Window', special: true, breakdownKey: 'sellable' },
        ];

        // ============================================================
        // API STATUS CHECK
        // ============================================================
        async function checkAPI() {
            const statusEl = document.getElementById('dataStatus');
            const dotEl = document.getElementById('statusDot');
            const progressEl = document.getElementById('progressBar');

            try {
                const response = await fetch('/api/stats');
                const stats = await response.json();

                if (stats.status === 'loading') {
                    statusEl.textContent = 'Loading data...';
                    dotEl.className = 'status-dot loading';
                    progressEl.className = 'progress-bar-container visible';
                    document.getElementById('searchBtn').disabled = true;
                    setTimeout(checkAPI, 2000);
                    return;
                }

                if (stats.status === 'error') {
                    statusEl.textContent = stats.message;
                    dotEl.className = 'status-dot error';
                    progressEl.className = 'progress-bar-container';
                    return;
                }

                statusEl.textContent = `${stats.eurotax_count.toLocaleString()} records`;
                dotEl.className = 'status-dot ready';
                progressEl.className = 'progress-bar-container';
                document.getElementById('searchBtn').disabled = false;
            } catch (err) {
                statusEl.textContent = 'Connecting...';
                dotEl.className = 'status-dot loading';
                progressEl.className = 'progress-bar-container visible';
                setTimeout(checkAPI, 2000);
            }
        }

        // ============================================================
        // SEARCH
        // ============================================================
        async function search() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            isSearching = true;
            const statusEl = document.getElementById('searchStatus');
            const searchBtn = document.getElementById('searchBtn');

            statusEl.textContent = 'Searching...';
            statusEl.className = 'search-status';
            searchBtn.disabled = true;
            document.getElementById('progressBar').className = 'progress-bar-container visible';

            try {
                const profile = document.getElementById('profileSelect').value;
                const response = await fetch(`/api/search?code=${encodeURIComponent(query)}&profile=${encodeURIComponent(profile)}`);
                const result = await response.json();

                currentData = result;
                showAllCands = false;

                // Update URL hash for browser navigation
                window.location.hash = query;

                if (result.found && result.candidate_count > 0) {
                    statusEl.textContent = `${result.candidate_count} candidate(s)`;
                    statusEl.className = 'search-status success';
                    document.getElementById('noCandidates').className = 'no-candidates-card';
                    await renderResult(result);
                } else if (result.found) {
                    statusEl.textContent = 'No Eurotax candidates';
                    statusEl.className = 'search-status error';
                    document.getElementById('noResults').className = 'no-results';
                    document.getElementById('noCandidates').className = 'no-candidates-card visible';
                    await renderResult(result);
                } else {
                    statusEl.textContent = result.error || 'Not found';
                    statusEl.className = 'search-status error';
                    document.getElementById('mainPanel').className = 'main-panel';
                    document.getElementById('noCandidates').className = 'no-candidates-card';
                    document.getElementById('noResults').className = 'no-results visible';
                }
            } catch (err) {
                statusEl.textContent = 'API error - check VPN';
                statusEl.className = 'search-status error';
            } finally {
                searchBtn.disabled = false;
                document.getElementById('progressBar').className = 'progress-bar-container';
                isSearching = false;
            }
        }

        function searchCode(code) {
            document.getElementById('searchInput').value = code;
            window.location.hash = code;
            search();
        }

        // ============================================================
        // SHOW ALL CANDIDATES
        // ============================================================
        async function showAllCandidates() {
            showAllCands = true;
            if (currentData) {
                await renderResult(currentData);
            }
        }

        // ============================================================
        // RENDER RESULT
        // ============================================================
        async function renderResult(data) {
            document.getElementById('noResults').className = 'no-results';
            document.getElementById('mainPanel').className = 'main-panel visible';

            // Populate vehicle identity inline with search bar
            const viDiv = document.getElementById('vehicleIdentity');
            document.getElementById('vehicleMake').textContent = data.brand || '';
            document.getElementById('vehicleVersion').textContent = data.infocar_name || '';
            viDiv.style.display = (data.brand || data.infocar_name) ? 'flex' : 'none';

            const existingMapping = data.existing_mapping;
            const maxScore = data.max_score || 157;
            const profileName = data.weight_profile || 'default';
            const info = data.infocar_specs;
            const cands = data.candidates || [];

            // --- Existing mapping: determine if in visible candidates or far-right ---
            const existingNatcode = existingMapping ? existingMapping.dest_code : null;

            // Determine visible candidates (natural rank order, no extraction)
            const maxVisible = showAllCands ? Math.min(cands.length, 10) : 3;
            const visibleCands = cands.slice(0, maxVisible);
            const hasMore = !showAllCands && cands.length > 3;

            // Check if existing mapping is among visible candidates
            let existingVisibleIdx = -1;
            if (existingNatcode) {
                existingVisibleIdx = visibleCands.findIndex(c => c.natcode === existingNatcode);
            }

            // If existing mapping is NOT among visible candidates, fetch its data for far-right column
            let existingFarRight = null;
            if (existingNatcode && existingVisibleIdx < 0) {
                try {
                    const resp = await fetch(`/api/eurotax/${encodeURIComponent(existingNatcode)}`);
                    const etxData = await resp.json();
                    if (etxData.found) {
                        existingFarRight = {
                            natcode: existingNatcode,
                            eurotax_code: etxData.eurotax_code,
                            eurotax_name: etxData.eurotax_name,
                            specs: etxData.specs,
                            score: null,
                            breakdown: null,
                            oem_match_type: null
                        };
                    } else {
                        existingFarRight = {
                            natcode: existingNatcode,
                            eurotax_code: '-',
                            eurotax_name: 'Not found in catalog',
                            specs: {},
                            score: null,
                            breakdown: null,
                            oem_match_type: null
                        };
                    }
                } catch (err) {
                    console.warn('Failed to fetch existing mapping specs:', err);
                    existingFarRight = {
                        natcode: existingNatcode,
                        eurotax_code: '-',
                        eurotax_name: 'Failed to load',
                        specs: {},
                        score: null,
                        breakdown: null,
                        oem_match_type: null
                    };
                }
            }

            // ---- TABLE LAYOUT: fixed for default view, auto for expanded ----
            const tableEl = document.querySelector('.comparison-table');
            if (showAllCands && cands.length > 5) {
                tableEl.classList.add('expanded');
            } else {
                tableEl.classList.remove('expanded');
            }

            // ---- TABLE HEADER ----
            let headHtml = '<tr><th class="col-field col-header-field">Field</th>';

            // Source column header
            headHtml += `<th class="col-source col-header-source">
                <div class="th-title">INFOCAR (Source)</div>
                <div class="th-code">
                    <span class="copiable-code" onclick="copyCode('${data.infocar_provider_code}')" title="Click to copy">
                        ${data.infocar_provider_code} ${copyIconSvg}
                    </span>
                </div>
            </th>`;

            // Gap column between source and candidates
            headHtml += '<th class="col-gap-header"></th>';

            // Candidate columns (highlighted if existing mapping)
            visibleCands.forEach((c, i) => {
                const natcode = c.natcode || '-';
                const score = c.score || 0;
                const isExisting = (i === existingVisibleIdx);
                const headerClass = isExisting ? 'col-header-cand-existing' : 'col-header-cand';
                const existingBadge = isExisting ? ' <span class="existing-badge">EXISTING</span>' : '';

                headHtml += `<th class="col-cand ${headerClass}">
                    ${renderScoreBar(score, maxScore)}
                    <div class="natcode-row">
                        <span class="copiable-code" onclick="copyCode('${natcode}')" title="Click to copy">
                            ${natcode} ${copyIconSvg}
                        </span>
                        ${existingBadge}
                        ${isExisting ? '' : `<button class="map-btn" id="mapBtn${i}" onclick="submitMapping(${i}, '${natcode}', ${score})">Map it</button>`}
                    </div>
                </th>`;
            });

            // "+N more" column
            if (hasMore) {
                headHtml += `<th class="col-cand see-more-col">
                    <button class="see-more-btn" onclick="showAllCandidates()">+${cands.length - maxVisible} more</button>
                </th>`;
            }

            // Far-right existing mapping column (NOT in visible candidates)
            if (existingFarRight) {
                const ecNatcode = existingFarRight.natcode;
                const metaScore = existingMapping.score != null ? existingMapping.score : 'N/A';
                const strategy = existingMapping.strategy || 'N/A';

                headHtml += `<th class="col-cand col-header-existing-only">
                    <div class="th-title">EXISTING <span class="existing-badge not-in-top">NOT IN TOP ${maxVisible}</span> <span style="font-size:10px;font-weight:400;color:var(--slate-400);margin-left:4px;">Score: ${metaScore} | ${strategy}</span></div>
                    <div class="natcode-row">
                        <span class="copiable-code" onclick="copyCode('${ecNatcode}')" title="Click to copy">
                            ${ecNatcode} ${copyIconSvg}
                        </span>
                    </div>
                </th>`;
            }

            headHtml += '</tr>';
            document.getElementById('tableHead').innerHTML = headHtml;

            const infocarTrims = data.infocar_trims || [];
            const weights = (availableProfiles[profileName] || {}).weights || {};

            // ---- CANDIDATE CELL RENDERER ----
            function renderCandCell(c, field, extraClass) {
                let candVal, candDisp, candNorm;

                if (field.key === '_make') {
                    candVal = data.brand;
                    candDisp = candVal ?? '-';
                } else if (field.key === '_code') {
                    candVal = c.eurotax_code;
                    const oemType = c.oem_match_type || 'NONE';
                    candDisp = `${candVal ?? '-'} ${getOemMatchBadge(oemType)}`;
                } else if (field.key === '_sellable_window') {
                    candVal = c.specs ? { begin: c.specs.sellable_begin, end: c.specs.sellable_end } : {};
                    candDisp = c.specs ? formatWindow(c.specs.sellable_begin, c.specs.sellable_end) : '-';
                } else if (field.key === '_trim_level') {
                    const matched = c.trim_matched || [];
                    const targetOnly = c.trim_target_only || [];
                    const allTrims = [...matched, ...targetOnly];
                    candVal = allTrims;
                    candDisp = allTrims.length > 0 ? allTrims.map(t => t.toUpperCase()).join(', ') : '-';
                } else {
                    candVal = c.specs ? c.specs[field.key] : null;
                    candDisp = field.format ? field.format(candVal) : (candVal ?? '-');
                }
                candNorm = field.normKey && c.specs ? (c.specs[field.normKey] || null) : null;

                let matchClass = '';
                let matchIcon = '';

                if (field.key === '_code' && c.breakdown) {
                    const m = getMatchFromBreakdown('oem', c.breakdown, weights);
                    matchClass = m.matchClass || '';
                    matchIcon = m.matchIcon || '';
                } else if (field.isTrim && c.breakdown) {
                    const m = getMatchFromBreakdown('trim', c.breakdown, weights);
                    matchClass = m.matchClass || '';
                    matchIcon = m.matchIcon || '';
                } else if (field.breakdownKey && c.breakdown) {
                    const m = getMatchFromBreakdown(field.breakdownKey, c.breakdown, weights);
                    matchClass = m.matchClass || '';
                    matchIcon = m.matchIcon || '';
                }

                // Always apply match borders, then append extraClass
                let cellBgClass = '';
                if (matchClass === 'match-yes') cellBgClass = 'cell-match-border';
                else if (matchClass === 'match-warn') cellBgClass = 'cell-warn-border';
                else if (matchClass === 'match-no') cellBgClass = 'cell-mismatch-border';
                if (extraClass) cellBgClass += ' ' + extraClass;

                return `<td class="col-cand ${cellBgClass}">
                    <div class="cell-value" style="${field.special ? 'font-family:var(--font-mono);font-size:11px;' : ''}">${candDisp}${matchIcon ? `<span class="cell-match ${matchClass}">${matchIcon}</span>` : ''}</div>
                    ${candNorm ? `<div class="cell-normalized">\u2192 ${candNorm}</div>` : ''}
                </td>`;
            }

            // ---- FAR-RIGHT EXISTING CELL RENDERER (no scoring data) ----
            function renderExistingFarRightCell(ec, field) {
                let candDisp, candNorm;
                if (field.key === '_make') {
                    candDisp = ec.specs && ec.specs.make ? ec.specs.make : '-';
                } else if (field.key === '_code') {
                    candDisp = `${ec.eurotax_code ?? '-'} ${getOemMatchBadge('NONE')}`;
                } else if (field.key === '_sellable_window') {
                    candDisp = ec.specs ? formatWindow(ec.specs.sellable_begin, ec.specs.sellable_end) : '-';
                } else if (field.key === '_trim_level') {
                    candDisp = '-';
                } else {
                    const val = ec.specs ? ec.specs[field.key] : null;
                    candDisp = field.format ? field.format(val) : (val ?? '-');
                }
                candNorm = field.normKey && ec.specs ? (ec.specs[field.normKey] || null) : null;
                return `<td class="col-cand col-existing-not-matched">
                    <div class="cell-value" style="${field.special ? 'font-family:var(--font-mono);font-size:11px;' : ''}">${candDisp}</div>
                    ${candNorm ? `<div class="cell-normalized">\u2192 ${candNorm}</div>` : ''}
                </td>`;
            }

            // ---- TABLE BODY ----
            let bodyHtml = '';
            FIELDS.forEach(field => {
                let infoVal, infoDisp, infoNorm;

                // Extract source value
                if (field.key === '_make') {
                    infoVal = data.brand;
                    infoDisp = infoVal ?? '-';
                } else if (field.key === '_code') {
                    infoVal = data.infocar_code;
                    infoDisp = infoVal ?? '-';
                } else if (field.key === '_sellable_window') {
                    infoVal = { begin: info.sellable_begin, end: info.sellable_end };
                    infoDisp = formatWindow(info.sellable_begin, info.sellable_end);
                } else if (field.key === '_trim_level') {
                    infoVal = infocarTrims;
                    infoDisp = infocarTrims.length > 0 ? infocarTrims.map(t => t.toUpperCase()).join(', ') : '-';
                } else {
                    infoVal = info[field.key];
                    infoDisp = field.format ? field.format(infoVal) : (infoVal ?? '-');
                }
                infoNorm = field.normKey ? (info[field.normKey] || null) : null;

                bodyHtml += `<tr>
                    <td class="col-field">${field.label}</td>
                    <td class="col-source">
                        <div class="cell-value" style="${field.special ? 'font-family:var(--font-mono);font-size:11px;' : ''}">${infoDisp}</div>
                        ${infoNorm ? `<div class="cell-normalized">\u2192 ${infoNorm}</div>` : ''}
                    </td>`;

                // Gap column between source and candidates
                bodyHtml += '<td class="col-gap"></td>';

                // Regular candidate cells (with purple highlight if existing)
                visibleCands.forEach((c, i) => {
                    const isExisting = (i === existingVisibleIdx);
                    bodyHtml += renderCandCell(c, field, isExisting ? 'col-cand-existing' : '');
                });

                if (hasMore) bodyHtml += '<td class="col-cand see-more-col"></td>';

                // Far-right existing cell
                if (existingFarRight) {
                    bodyHtml += renderExistingFarRightCell(existingFarRight, field);
                }

                bodyHtml += '</tr>';
            });

            document.getElementById('tableBody').innerHTML = bodyHtml;
        }

        // ============================================================
        // MAPPING SUBMISSION
        // ============================================================
        async function submitMapping(index, natcode, score) {
            if (!currentData || !currentData.infocar_provider_code) {
                showToast('No data to map', 'error');
                return;
            }

            const btn = document.getElementById(`mapBtn${index}`);
            btn.disabled = true;
            btn.textContent = 'Mapping...';

            try {
                const response = await fetch('/api/mapping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_code: currentData.infocar_provider_code,
                        dest_code: natcode,
                        score: score,
                        country: 'it'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    btn.textContent = 'Mapped!';
                    btn.classList.add('mapped');
                    showToast(`Mapping created: ${currentData.infocar_provider_code} \u2192 ${natcode}`, 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create mapping');
                }
            } catch (err) {
                btn.textContent = 'Map';
                btn.disabled = false;
                showToast(`Error: ${err.message}`, 'error');
            }
        }

        // ============================================================
        // TOAST
        // ============================================================
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // ============================================================
        // COPY TO CLIPBOARD
        // ============================================================
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showToast(`Copied: ${code}`, 'info');
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }

        // ============================================================
        // URL HASH NAVIGATION
        // ============================================================
        window.addEventListener('hashchange', () => {
            const code = window.location.hash.replace('#', '').trim();
            if (code && !isSearching && code !== currentData?.infocar_provider_code) {
                document.getElementById('searchInput').value = code;
                search();
            }
        });

        // ============================================================
        // INITIALIZE
        // ============================================================
        let hashAutoSearchDone = false;

        // Wrap checkAPI to auto-search hash code after API becomes ready
        const _origCheckAPI = checkAPI;
        checkAPI = async function() {
            await _origCheckAPI();
            if (!hashAutoSearchDone) {
                const dot = document.getElementById('statusDot');
                if (dot.classList.contains('ready')) {
                    hashAutoSearchDone = true;
                    const hashCode = window.location.hash.replace('#', '').trim();
                    if (hashCode) {
                        document.getElementById('searchInput').value = hashCode;
                        search();
                    }
                }
            }
        };

        document.getElementById('progressBar').className = 'progress-bar-container visible';
        fetchProfiles();
        checkAPI();
        document.getElementById('searchInput').focus();
    </script>
</body>
</html>
